import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
import os
import time
import random
from inspect import getmembers
from sqlconnector import SQLConnector

def main():
    #finding the current path to get local files
    __location__ = os.path.realpath(
    os.path.join(os.getcwd(), os.path.dirname(__file__)))

    #taking all the necessary information for sending emails
    subject = ''
    body_text = ''
    body_html = ''
    with open(os.path.join(__location__, 'Email Database\\TestResult.txt')) as f:
        subject = f.readline()
        body_text = f.readline()
        body_html = f.read()
    sender = ''
    password = ''

    #reading the sender, password, and recipient information from files
    with open(os.path.join(__location__, 'password.txt')) as f:
        sender = f.readline().strip()
        password = f.readline().strip()
    recipients = []
    """
    with open(os.path.join(__location__, 'emaillist.txt')) as f:
        recipients = f.read().splitlines()
    """

    #Create sql connector
    sql_connector = SQLConnector()
    organizations = sql_connector.get_organization_names()
    for o in organizations:
        org_recipients = sql_connector.get_organization_rows(o)
        for r in org_recipients:
            recipients.append(r[0])
    #creates a dictionary of all emails corresponding to the user's name
    rec_dict = {}
    for i in recipients:
        
        rec_dict[i] = "sir"

    #waiting a random time between 22 and 26 hours before sending an email
    # wait_time = random.randint(79200, 93600)
    # time.sleep(wait_time)
    for rec_email, rec_name in rec_dict.items():
        uuid = sql_connector.get_recipient(rec_email)[0]
        send_email(subject, body_text, body_html, sender, rec_email, rec_name, password)

#sends the email using the gathered information
def send_email(subject, body_text, body_html, sender, rec_email, rec_name, password):
    msg = MIMEMultipart('alternative')
    msg['Subject'] = subject
    msg['From'] = 'Totally Real Test Results'
    msg['To'] = rec_email
    #print(getmembers(msg))

    #formats the email with the user's first name
    body_text = body_text.format(rec_name.split()[0])
    body_html = body_html.format(rec_name.split()[0])

    #assembles the email contents
    part1 = MIMEText(body_text, 'plain')
    part2 = MIMEText(body_html, 'html')

    msg.attach(part1)
    msg.attach(part2)

    #send the emails
    with smtplib.SMTP_SSL('smtp.gmail.com', 465) as smtp_server:
       smtp_server.login(sender, password)
       smtp_server.sendmail(sender, rec_email, msg.as_string())
    print("Message sent!")


if __name__ == '__main__':
    main()

