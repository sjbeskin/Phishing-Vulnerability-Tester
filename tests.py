import unittest
from sqlconnector import SQLConnector, Recipient

from pathlib import Path
import sqlite3

from sqlconnector import Recipient


class TestSQLConnectorMethods(unittest.TestCase):

    def setUp(self):
        #Runs each time before a test
        self.sqlconn = SQLConnector(testing_mode=True)
    
    def test_db_creation(self):
        #Check the db exists and has nothing in it
        test_db_file = Path("TestingDB.db")
        self.assertTrue(test_db_file.is_file())

        connection = sqlite3.connect("TestingDB.db") 
        crsr = connection.cursor()

        crsr.execute(f"SELECT * FROM organizations")
        query_result = crsr.fetchall()
        self.assertEqual(len(query_result), 0)


    def test_add_recipient(self):
        self.assertEqual(self.sqlconn.get_organization_names(), [])
        self.sqlconn.add_recipients([Recipient("user@example.com", "example.organization")])
        self.assertEqual(self.sqlconn.get_organization_names(), ["example.organization"])
        self.assertEqual(self.sqlconn.get_organization_rows("example.organization"), [('user@example.com', 0)])

    def test_get_organization(self):
        self.sqlconn.add_recipients([Recipient("user@example.com", "example.organization")])
        user = self.sqlconn.get_recipient("user@example.com")
        self.assertEqual(user[2], "example.organization")

    def test_get_clicks(self):
        self.sqlconn.add_recipients([Recipient("user@example.com", "example.organization")])
        user = self.sqlconn.get_recipient("user@example.com")
        self.assertEqual(user[3], 0)

    def test_add_clicks(self):
        self.sqlconn.add_recipients([Recipient("user@example.com", "example.organization")])
        user = self.sqlconn.get_recipient("user@example.com")
        self.sqlconn.register_recipient_scam_click(user[0])
        self.sqlconn.register_recipient_scam_click(user[0])
        self.sqlconn.register_recipient_scam_click(user[0])
        user = self.sqlconn.get_recipient("user@example.com")
        self.assertEqual(user[3], 3)

if __name__ == '__main__':
    unittest.main()