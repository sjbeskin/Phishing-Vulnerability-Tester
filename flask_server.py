from flask import Flask, jsonify, request, redirect, render_template
from flask_cors import CORS, cross_origin
from sqlconnector import SQLConnector
import os
import json

# Create Flask Server + Handle CORS
app = Flask(__name__)
cors = CORS(app)
app.config['CORS_HEADERS'] = 'Content-Type'

# Gets current location
__location__ = os.path.realpath(
os.path.join(os.getcwd(), os.path.dirname(__file__)))

# Handle requests going to the base link
# Gets the UUID from the link request and registers it in the database
@app.route('/', methods=['GET'])
@cross_origin
def test():
    try:
        uuid = request.args.get('id')
        sql_conn = SQLConnector()
        sql_conn.register_recipient_scam_click(uuid)
    except ValueError:
        #No id
        print("No id")
    return redirect('https://www.google.com', code=302)

# Link for adding a file containing the email recipients
# Opens an html page with the option to submit a file
@app.route('/addrecipient', methods=['GET', 'POST'])
def add_recipient():
    if request.method == 'POST':
        if 'file' not in request.files:
            print('NO FILE')
            return redirect('https://www.google.com')
        file = request.files['file']
        print(file.filename)
        file.save(file.filename)
        f = open(file.filename)
        jsonparsed = json.load(f)
        print(jsonparsed)
    return render_template('test.html')


if __name__=='__main__':
    app.run(debug=True, port=8080)